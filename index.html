<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GLOEX Hub — Modern Portfolio & Demos</title>
  <!-- Tailwind CDN (production-ready utilities) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --green-600:#0ea45c;
      --green-700:#0b8b4d;
      --accent-blue:#2563eb; /* blue */
      --accent-pink:#ff49a1; /* pink */
      --glass: rgba(255,255,255,0.6);
    }

    html,body{height:100%;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#f6fbff 0%,#fff 100%);} 

    /* Header & Footer colors: green as requested */
    header.site-header{background:linear-gradient(90deg,var(--green-600),var(--green-700));}
    footer.site-footer{background:linear-gradient(90deg,var(--green-700),#06643a);}

    /* Logo animation */
    .logo-badge{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.12);backdrop-filter:blur(4px);}
    .logo-badge svg{transform-origin:center;animation:logo-spin 8s linear infinite;}
    @keyframes logo-spin{0%{transform:rotate(0deg)}50%{transform:rotate(12deg)}100%{transform:rotate(0deg)}}

    /* Floating hero illustration */
    .hero-illustration{animation:float 6s ease-in-out infinite;}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-12px)}100%{transform:translateY(0)}}

    /* Fancy CTA shimmer */
    .cta-shimmer{position:relative;overflow:hidden}
    .cta-shimmer::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,transparent,rgba(255,255,255,0.08),transparent);transform:translateX(-110%);animation:shimmer 2.6s linear infinite}
    @keyframes shimmer{100%{transform:translateX(110%)}}

    /* Card hover subtle */
    .card-elevated{transition:transform .28s cubic-bezier(.2,.9,.3,1),box-shadow .28s}
    .card-elevated:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(16,24,40,0.12)}

    /* Small utility for line clamp but not reliant on plugin */
    .line-clamp-3{display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;-webkit-line-clamp:3}

    /* Responsive modal tweaks */
    .modal-backdrop{backdrop-filter:blur(3px)}

    /* Colored section styles */
    .accent-blue-bg{background:linear-gradient(180deg,rgba(37,99,235,0.08),rgba(37,99,235,0.02));}
    .accent-pink-bg{background:linear-gradient(180deg,rgba(255,73,161,0.06),rgba(255,73,161,0.02));}
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="site-header text-white sticky top-0 z-40 shadow">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center gap-4">
      <a href="#" onclick="currentState.view='dashboard';renderApp();return false;" class="flex items-center gap-3 no-underline">
        <div class="logo-badge ring-1 ring-white/10 p-1">
          <!-- simple logo svg -->
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <rect x="2" y="2" width="20" height="20" rx="5" fill="white" fill-opacity="0.08"></rect>
            <path d="M6 12h12M12 6v12" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-xl font-extrabold leading-none">GLOEX Hub</h1>
          <p class="text-xs opacity-90">ELIJUL GROUPS LTD — Kigali</p>
        </div>
      </a>

      <!-- Search -->
      <form id="search-form" onsubmit="handleSearch(event)" class="flex-1">
        <label class="sr-only">Search projects</label>
        <div class="relative">
          <input name="query" placeholder="Search projects, users, keywords..." class="w-full rounded-full pl-4 pr-12 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-300"/>
          <button type="submit" class="absolute right-1 top-1/2 -translate-y-1/2 p-2 rounded-full text-green-800 bg-white/90 shadow-sm">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"></path></svg>
          </button>
        </div>
      </form>

      <nav id="nav-actions" class="ml-4"></nav>
    </div>
  </header>

  <!-- HERO -->
  <main class="flex-1">
    <section class="max-w-7xl mx-auto px-6 pt-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
        <div>
          <h2 class="text-3xl lg:text-4xl font-extrabold text-gray-900">Showcase & Discover Creative Projects</h2>
          <p class="mt-3 text-gray-600">Share demos, find collaborators, and get inspired by makers from around the world. Production-ready, modern UI with instant previews and easy sharing.</p>

          <div class="mt-6 flex flex-wrap gap-3">
            <a href="#" onclick="currentState.view='dashboard';renderApp();return false;" class="inline-flex items-center gap-2 px-5 py-3 rounded-full bg-white text-green-700 font-semibold shadow cta-shimmer">Explore Projects</a>
            <a href="#post" onclick="document.getElementById('post-form-anchor')?.scrollIntoView({behavior:'smooth'});" class="inline-flex items-center gap-2 px-5 py-3 rounded-full bg-green-600 text-white font-semibold shadow hover:bg-green-700">Post Your Project</a>
            <a href="#contact" class="inline-flex items-center gap-2 px-4 py-3 rounded-full border border-gray-200 text-sm text-gray-700">Contact Us</a>
          </div>

          <div class="mt-6 grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 rounded-lg bg-white card-elevated">
              <div class="font-semibold text-green-700">Starting from</div>
              <div class="text-xl font-bold">20,000 FRW</div>
            </div>
            <div class="p-3 rounded-lg bg-white card-elevated">
              <div class="font-semibold text-blue-600">Demos</div>
              <div class="text-xl font-bold">Live & Source-ready</div>
            </div>
          </div>

          <div class="mt-6 flex items-center gap-3">
            <a href="https://github.com/django-oscar/django-oscar" target="_blank" class="text-xs bg-blue-50 px-3 py-2 rounded-lg font-medium text-blue-700">Open-source eCommerce</a>
            <a href="https://gitlab.com/bizimanasoftware/" target="_blank" class="text-xs bg-pink-50 px-3 py-2 rounded-lg font-medium text-pink-600">Our GitLab</a>
          </div>
        </div>

        <div class="relative">
          <div class="bg-gradient-to-br from-white to-green-50 rounded-2xl p-6 shadow-lg flex items-center gap-6">
            <div class="w-1/2">
              <img src="tank_picture.png" alt="Animated illustration" class="hero-illustration w-full h-auto rounded-md shadow" onerror="this.src='https://images.unsplash.com/photo-1526378726728-6e715cfed7b9?auto=format&fit=crop&w=900&q=60'">
            </div>
            <div class="w-1/2">
              <h3 class="text-lg font-bold text-gray-800">Fast, Reliable Delivery</h3>
              <p class="text-sm text-gray-600 mt-2">We connect suppliers, transporters and customers — track orders and get email receipts automatically.</p>
              <div class="mt-4 flex gap-2">
                <a href="#" class="px-4 py-2 rounded-full bg-blue-600 text-white text-sm">See Workflow</a>
                <a href="#" class="px-4 py-2 rounded-full bg-pink-500 text-white text-sm">Request Quote</a>
              </div>
            </div>
          </div>

          <!-- subtle badge -->
          <div class="absolute -bottom-4 right-6 bg-white p-3 rounded-xl shadow flex items-center gap-3">
            <svg class="w-6 h-6 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
            <div class="text-xs">Reliable payments (Stripe) • Email receipts</div>
          </div>
        </div>
      </div>
    </section>

    <!-- FEATURES (blue & pink sections) -->
    <section class="mt-12">
      <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-2xl p-6 accent-blue-bg card-elevated">
          <h4 class="font-bold text-xl text-blue-800">Developer Friendly</h4>
          <p class="mt-2 text-sm text-gray-600">APIs, webhooks, CI/CD-friendly deployments and ready-made webhooks for billing, email verification and password resets.</p>
          <ul class="mt-4 text-sm space-y-2 text-gray-700">
            <li>• REST API endpoints</li>
            <li>• Stripe integration</li>
            <li>• CSRF-aware forms</li>
          </ul>
        </div>

        <div class="rounded-2xl p-6 accent-pink-bg card-elevated">
          <h4 class="font-bold text-xl text-pink-700">Design & Branding</h4>
          <p class="mt-2 text-sm text-gray-600">Logos, animated illustrations and on-brand assets. Editable source files included.</p>
          <div class="mt-4 text-sm text-gray-700">• Logo design • Motion graphics • Social banners</div>
        </div>

        <div class="rounded-2xl p-6 bg-white card-elevated">
          <h4 class="font-bold text-xl text-green-700">Business Ready</h4>
          <p class="mt-2 text-sm text-gray-600">Multi-vendor support, purchase order emails, transporter tracking and role-based access for agents, suppliers & transporters.</p>
        </div>
      </div>
    </section>

    <!-- PROJECTS / DASHBOARD AREA -->
    <section class="max-w-7xl mx-auto px-6 mt-12">
      <div id="projects-root">
        <!-- Rendered by JS -->
      </div>
    </section>

    <!-- POST FORM ANCHOR -->
    <div id="post-form-anchor"></div>

  </main>

  <!-- CONTACT & FOOTER -->
  <footer class="site-footer text-white mt-12">
    <div class="max-w-7xl mx-auto px-6 py-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div>
        <h5 class="font-bold text-lg">GLOEX.ORG</h5>
        <p class="text-sm opacity-90 mt-2">ELIJUL GROUPS LTD — Digital Solutions in Kigali, Rwanda</p>
        <p class="text-sm mt-3">Email: <a href="mailto:infogloex@proton.me" class="underline">infogloex@proton.me</a></p>
        <p class="text-sm">Phone/WhatsApp: +250788660513</p>
      </div>
      <div>
        <h6 class="font-semibold">Quick Links</h6>
        <ul class="mt-3 space-y-2 text-sm">
          <li><a href="#" onclick="currentState.view='dashboard';renderApp();return false;" class="underline">Explore Projects</a></li>
          <li><a href="#" onclick="document.getElementById('post-form-anchor')?.scrollIntoView({behavior:'smooth'});" class="underline">Post Project</a></li>
          <li><a href="#contact" class="underline">Contact</a></li>
        </ul>
      </div>
      <div>
        <h6 class="font-semibold">Location</h6>
        <p class="text-sm mt-3">Kigali, Rwanda</p>
        <div class="mt-4">
          <a href="https://www.gloex.org" target="_blank" class="inline-block px-4 py-2 rounded-full bg-white text-green-700 font-semibold">Visit website</a>
        </div>
      </div>
    </div>
    <div class="border-t border-white/10 py-4 text-center text-sm">© <span id="year"></span> ELIJUL GROUPS LTD — All rights reserved.</div>
  </footer>

  <!-- MESSAGE BOX & MODAL -->
  <div id="message-box" class="fixed top-6 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-xl text-white font-semibold shadow-lg opacity-0 pointer-events-none transition-opacity"></div>

  <div id="project-detail-modal" class="hidden fixed inset-0 z-50 items-center justify-center modal-backdrop">
    <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 overflow-auto max-h-[90vh] shadow-xl" id="modal-content"></div>
  </div>

  <!-- MAIN JAVASCRIPT: API interactions + rendering (keeps previous features intact) -->
  <script>
    // --- Config ---
    const API_BASE_URL = 'https://gloex.pythonanywhere.com/api';

    // --- State ---
    window.currentState = { user:null, projects:[], view:'dashboard', currentProjectDetail:null, searchQuery:'', portfolioUser:null };

    // --- Utilities ---
    function showMessage(text,type='success'){ const el=document.getElementById('message-box'); el.textContent=text; el.style.backgroundColor= type==='success' ? 'var(--green-600)' : '#ef4444'; el.style.opacity=1; el.style.pointerEvents='auto'; setTimeout(()=>{el.style.opacity=0;el.style.pointerEvents='none'},3500)}

    function getCsrfToken(){ const token=document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken=')); return token?decodeURIComponent(token.split('=')[1]):null }

    async function fetchData(url, options={}){
      const defaultHeaders={ 'Content-Type':'application/json' };
      const config = { credentials:'include', ...options, headers:{...defaultHeaders,...options.headers} };
      if (options.method && options.method!=='GET' && !(options.body instanceof FormData)){
        const csr=getCsrfToken(); if(csr) config.headers['X-CSRFToken']=csr;
      }
      if (options.body instanceof FormData) delete config.headers['Content-Type'];
      const res = await fetch(url, config);
      const ct = res.headers.get('content-type')||'';
      if(!res.ok){ const err = ct.includes('application/json')? await res.json() : { error: 'HTTP '+res.status }; if(res.status===401||res.status===403){ currentState.user=null; renderApp(); } throw new Error(err.error||err.detail||'Request failed') }
      return ct.includes('application/json')? res.json() : res;
    }

    // --- API calls ---
    async function checkAuth(){ try{ const user = await fetchData(`${API_BASE_URL}/user/`); currentState.user = user.is_authenticated ? user : null; }catch(e){ currentState.user=null } }
    async function fetchProjects(username=null){ let url = username? `${API_BASE_URL}/portfolio/${username}/` : `${API_BASE_URL}/projects/`; try{ currentState.projects = await fetchData(url); }catch(e){ showMessage('Failed to load projects: '+e.message,'error'); currentState.projects=[] } }
    async function fetchProjectDetail(id){ try{ const p = await fetchData(`${API_BASE_URL}/projects/${id}/`); currentState.currentProjectDetail=p; renderProjectDetailModal(); }catch(e){ showMessage('Failed: '+e.message,'error') } }

    // actions
    async function handleSearch(event){ event?.preventDefault(); const q = (event?.target?.query?.value || '').trim(); currentState.searchQuery=q; currentState.view='dashboard'; if(!q) await fetchProjects(); else{ try{ currentState.projects = await fetchData(`${API_BASE_URL}/search/?q=${encodeURIComponent(q)}`) }catch(e){ showMessage('Search failed: '+e.message,'error'); currentState.projects=[] } } renderApp() }

    async function handleAuthForm(e,endpoint){ e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries()); try{ const user = await fetchData(`${API_BASE_URL}/${endpoint}/`,{method:'POST',body:JSON.stringify(data)}); currentState.user=user; showMessage('Welcome, '+user.username); currentState.view='dashboard'; renderApp(); }catch(err){ showMessage('Auth failed: '+err.message,'error') } }

    async function handleLogout(){ try{ await fetchData(`${API_BASE_URL}/logout/`,{method:'POST'}); currentState.user=null; showMessage('Logged out'); currentState.view='dashboard'; renderApp(); }catch(e){ showMessage('Logout failed','error') } }

    async function handlePostProject(e){ e.preventDefault(); const form = e.target; try{ const newProject = await fetchData(`${API_BASE_URL}/projects/`,{method:'POST',body:new FormData(form)}); currentState.projects.unshift(newProject); showMessage('Project posted!'); form.reset(); renderApp(); }catch(err){ showMessage('Post failed: '+err.message,'error') } }

    async function handleDeleteProject(id){ if(!confirm('Delete this project?')) return; try{ await fetchData(`${API_BASE_URL}/projects/${id}/`,{method:'DELETE'}); currentState.projects = currentState.projects.filter(p=>p.id!==id); showMessage('Deleted'); closeProjectDetailModal(); renderApp(); }catch(e){ showMessage('Could not delete: '+e.message,'error') } }

    async function handleLikeToggle(id){ if(!currentState.user){ showMessage('Login to like','error'); return } try{ const r = await fetchData(`${API_BASE_URL}/projects/${id}/like/`,{method:'POST',body:JSON.stringify({})}); const p = currentState.projects.find(x=>x.id===id); if(p) p.likes_count=r.likes_count; if(currentState.currentProjectDetail?.id===id){ currentState.currentProjectDetail.likes_count=r.likes_count; currentState.currentProjectDetail.user_has_liked = r.action==='liked'; renderProjectDetailModal(); } renderApp(); }catch(e){ showMessage('Like failed: '+e.message,'error') } }

    async function handlePostComment(e,projectId){ e.preventDefault(); const content = e.target.elements.comment_content.value.trim(); if(!content) return; try{ const newC = await fetchData(`${API_BASE_URL}/projects/${projectId}/comments/`,{method:'POST',body:JSON.stringify({content})}); currentState.currentProjectDetail.comments.unshift(newC); e.target.reset(); renderProjectDetailModal(); }catch(err){ showMessage('Comment failed: '+err.message,'error') } }
    async function handleDeleteComment(projectId,commentId){ if(!confirm('Delete comment?')) return; try{ await fetchData(`${API_BASE_URL}/projects/${projectId}/comments/${commentId}/`,{method:'DELETE'}); currentState.currentProjectDetail.comments = currentState.currentProjectDetail.comments.filter(c=>c.id!==commentId); renderProjectDetailModal(); showMessage('Comment deleted'); }catch(e){ showMessage('Could not delete: '+e.message,'error') } }

    // --- Rendering ---
    function renderHeaderNav(){ const nav = document.getElementById('nav-actions'); if(currentState.user){ nav.innerHTML = `<div class="flex items-center gap-3"><button onclick="currentState.view='portfolio';currentState.portfolioUser='${currentState.user.username}';renderApp()" class="text-sm font-medium bg-white/10 px-3 py-2 rounded-lg">My Portfolio</button><button onclick="handleLogout()" class="text-sm font-semibold bg-yellow-400 text-black px-3 py-2 rounded-lg">Logout</button></div>` } else { nav.innerHTML = `<div class="flex items-center gap-3"><button onclick="currentState.view='login';renderApp()" class="text-sm font-medium bg-white/10 px-3 py-2 rounded-lg">Login</button><button onclick="currentState.view='register';renderApp()" class="text-sm font-semibold bg-white px-3 py-2 rounded-lg text-green-700">Register</button></div>` } }

    function renderAuthView(){ return `
      <div class="max-w-2xl mx-auto bg-white rounded-2xl p-6 shadow mt-8">
        <div class="flex gap-4 mb-4">
          <button onclick="currentState.view='login';renderApp()" class="flex-1 py-2 rounded-lg ${currentState.view==='login'?'bg-green-600 text-white':'bg-gray-50'}">Login</button>
          <button onclick="currentState.view='register';renderApp()" class="flex-1 py-2 rounded-lg ${currentState.view==='register'?'bg-green-600 text-white':'bg-gray-50'}">Register</button>
        </div>
        ${currentState.view==='login'? renderLoginForm(): renderRegisterForm()}
      </div>
    ` }

    function renderLoginForm(){ return `<form onsubmit="handleAuthForm(event,'login')" class="space-y-3"><div><label class='sr-only'>Username</label><input name='username' required class='w-full p-3 border rounded-lg' placeholder='Username'></div><div><label class='sr-only'>Password</label><input name='password' type='password' required class='w-full p-3 border rounded-lg' placeholder='Password'></div><button class='w-full py-3 bg-green-600 text-white rounded-lg'>Sign in</button></form>` }
    function renderRegisterForm(){ return `<form onsubmit="handleAuthForm(event,'register')" class="space-y-3"><div><input name='username' required class='w-full p-3 border rounded-lg' placeholder='Username'></div><div><input name='email' type='email' class='w-full p-3 border rounded-lg' placeholder='Email (optional)'></div><div><input name='password' type='password' required class='w-full p-3 border rounded-lg' placeholder='Password'></div><button class='w-full py-3 bg-green-600 text-white rounded-lg'>Create account</button></form>` }

    function renderPostForm(){ if(!currentState.user) return ''; return `
      <div class='mt-8 bg-white rounded-2xl p-6 shadow' id='post'>
        <h3 class='text-lg font-bold text-gray-800'>Share Your Project</h3>
        <form onsubmit='handlePostProject(event)' enctype='multipart/form-data' class='mt-4 space-y-3'>
          <input name='title' required class='w-full p-3 border rounded-lg' placeholder='Project title'>
          <input name='project_url' type='url' required class='w-full p-3 border rounded-lg' placeholder='Demo link'>
          <select name='project_type' class='w-full p-3 border rounded-lg'>
            <option value='frontend'>Frontend</option>
            <option value='backend'>Backend</option>
            <option value='fullstack'>Fullstack</option>
            <option value='design'>Design</option>
          </select>
          <textarea name='description' rows='4' class='w-full p-3 border rounded-lg' placeholder='Short description'></textarea>
          <div class='flex gap-2'>
            <input name='screenshot' type='file' accept='image/*' class='w-full'>
            <input name='screenshot_url_fallback' type='url' placeholder='Image url' class='w-full p-3 border rounded-lg'>
          </div>
          <div class='flex items-center gap-2'><input name='is_public' type='checkbox' checked><label>Make public</label></div>
          <button class='w-full py-3 rounded-lg bg-green-600 text-white'>Submit Project</button>
        </form>
      </div>
    ` }

    function renderProjectCard(p){ const image = p.screenshot_url || 'https://via.placeholder.com/800x450?text=No+image'; return `
      <div class='bg-white rounded-2xl overflow-hidden card-elevated cursor-pointer' onclick='fetchProjectDetail(${p.id})'>
        <img src='${image}' alt='' class='w-full h-44 object-cover'>
        <div class='p-4'>
          <div class='flex items-start justify-between gap-2'>
            <div>
              <h4 class='font-semibold text-gray-800'>${escapeHtml(p.title)}</h4>
              <div class='text-xs text-gray-500'>By <a href='#' onclick="event.stopPropagation(); currentState.view='portfolio'; currentState.portfolioUser='${p.username}'; renderApp()">${p.username}</a></div>
            </div>
            <div class='text-sm px-2 py-1 rounded-full bg-blue-50 text-blue-700'>${p.project_type}</div>
          </div>
          <p class='mt-3 text-sm text-gray-600 line-clamp-3'>${escapeHtml(p.description || 'No description')}</p>
          <div class='mt-4 flex items-center justify-between text-sm text-gray-500'>
            <div class='flex items-center gap-2'><svg class='w-4 h-4 text-red-500' viewBox='0 0 20 20' fill='currentColor'><path d='M3.172 5.172A4 4 0 018.828 5.172L10 6.343l1.172-1.171a4 4 0 015.656 5.656L10 17.657 3.172 10.828a4 4 0 010-5.656z'></path></svg>${p.likes_count || 0}</div>
            <div class='text-xs text-gray-400'>${new Date(p.created_at || Date.now()).toLocaleDateString()}</div>
          </div>
        </div>
      </div>
    ` }

    function renderDashboardView(){ const projectsHtml = currentState.projects.length ? currentState.projects.map(renderProjectCard).join('') : `<div class='text-center py-14 text-gray-500'>No projects found.</div>`; return `
      <div>
        ${renderPostForm()}
        <h3 class='mt-8 mb-4 text-2xl font-bold'>Community Projects (${currentState.projects.length})</h3>
        <div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6'>${projectsHtml}</div>
      </div>
    ` }

    function renderProjectDetailModal(){ const modal = document.getElementById('project-detail-modal'); const content = document.getElementById('modal-content'); const p = currentState.currentProjectDetail; if(!p){ closeProjectDetailModal(); return }
      const isOwner = currentState.user?.id === p.user_id;
      const commentsHtml = (p.comments || []).map(c=>`<div class='border-b py-3'><div class='flex justify-between'><div><div class='font-semibold'>${c.username}</div><div class='text-sm text-gray-700'>${escapeHtml(c.content)}</div></div>${(isOwner||currentState.user?.id===c.user_id)?`<button onclick='handleDeleteComment(${p.id},${c.id})' class="text-red-500">&times;</button>`:''}</div><div class='text-xs text-gray-400 mt-2'>${new Date(c.created_at).toLocaleString()}</div></div>`).join('') || '<div class="text-sm text-gray-500">No comments yet</div>';

      content.innerHTML = `
        <div class='p-6 relative'>
          <button class='absolute right-4 top-4 text-gray-500' onclick='closeProjectDetailModal()'>✕</button>
          <div class='grid grid-cols-1 lg:grid-cols-3 gap-6'>
            <div class='lg:col-span-2'>
              <h2 class='text-2xl font-bold text-gray-900'>${escapeHtml(p.title)}</h2>
              <div class='text-sm text-gray-500 mt-1'>${p.project_type} • by <a href='#' onclick="currentState.view='portfolio';currentState.portfolioUser='${p.username}';closeProjectDetailModal();renderApp()">${p.username}</a></div>
              <img src='${p.screenshot_url||"https://via.placeholder.com/900x500?text=No+Screenshot"}' alt='' class='w-full mt-4 rounded-lg object-cover'>
              <div class='mt-4 flex items-center gap-3'>
                <button onclick='handleLikeToggle(${p.id})' class='px-4 py-2 rounded-lg ${p.user_has_liked?"bg-red-500 text-white":"bg-gray-100 text-gray-800"}'>${p.likes_count||0} ${p.user_has_liked? 'Unlike':'Like'}</button>
                <a href='${p.project_url}' target='_blank' class='px-4 py-2 rounded-lg bg-green-600 text-white'>View Live Demo</a>
                ${p.source_code_url?`<a href='${p.source_code_url}' target='_blank' class='px-4 py-2 rounded-lg bg-black text-white'>View Source</a>`:''}
              </div>
              <h4 class='mt-6 font-semibold'>Description</h4>
              <p class='text-gray-700 mt-2 whitespace-pre-wrap'>${escapeHtml(p.description||'No description provided')}</p>
            </div>
            <div>
              <div class='bg-gray-50 p-4 rounded-lg'>
                <h4 class='font-semibold'>Comments (${(p.comments||[]).length})</h4>
                ${ currentState.user? `<form onsubmit='handlePostComment(event, ${p.id})' class='mt-3'><textarea name='comment_content' rows='3' required class='w-full p-2 border rounded-lg' placeholder='Add a comment...'></textarea><button class='mt-2 w-full py-2 rounded-lg bg-blue-600 text-white text-sm'>Post Comment</button></form>` : `<div class='text-sm text-red-500 mt-3'>Log in to post comments</div>` }
                <div class='mt-4 max-h-[40vh] overflow-auto pr-2'>${commentsHtml}</div>
              </div>
            </div>
          </div>
        </div>
      `;
      modal.classList.remove('hidden'); modal.classList.add('flex'); }

    function closeProjectDetailModal(){ const modal = document.getElementById('project-detail-modal'); modal.classList.add('hidden'); modal.classList.remove('flex'); currentState.currentProjectDetail=null; if(window.history.pushState){ const newURL = window.location.protocol + '//' + window.location.host + window.location.pathname; window.history.pushState({path:newURL},'',newURL) } }

    // --- Helpers ---
    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    // --- App render ---
    async function renderApp(){ document.getElementById('year').textContent = new Date().getFullYear(); const root = document.getElementById('projects-root'); renderHeaderNav(); root.innerHTML = `<div class='text-center py-14 text-gray-400'>Loading...</div>`; switch(currentState.view){ case 'login': case 'register': root.innerHTML = renderAuthView(); break; case 'portfolio': await fetchProjects(currentState.portfolioUser); root.innerHTML = renderDashboardView(); break; default: if(!currentState.searchQuery) await fetchProjects(); root.innerHTML = renderDashboardView(); }
    }

    // --- Init ---
    async function init(){ await checkAuth(); const params = new URLSearchParams(location.search); const pid = params.get('project'); if(pid){ try{ await fetchProjectDetail(pid); }catch(e){} } renderApp(); }
    window.onload = init;
  </script>
</body>
</html>
