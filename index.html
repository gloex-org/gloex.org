<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gloEx Project Hub - Share Your Demos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">
                <a href="#" onclick="currentState.view='dashboard'; renderApp(); return false;" id="appTitle">gloEx Hub</a>
            </h1>
            <nav id="nav-actions">
                </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow" id="app-container">
        </main>

    <div id="message-box" class="fixed top-0 left-1/2 transform -translate-x-1/2 p-3 rounded-b-lg shadow-xl text-white font-semibold z-20 transition-all duration-300 opacity-0 pointer-events-none"></div>

    <div id="project-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            </div>
    </div>


    <script>
        // --- Configuration ---
        const API_BASE_URL = 'https://gloex.pythonanywhere.com/api';
        
        let currentState = {
            user: null,
            projects: [],
            loading: true,
            message: null,
            view: 'dashboard', // Default to dashboard on load
            currentProjectDetail: null, // For modal view
        };

        const PROJECT_TYPE_OPTIONS = [
            { value: 'frontend', label: 'Frontend Development' },
            { value: 'backend', label: 'Backend Development' },
            { value: 'fullstack', label: 'Full-Stack Application' },
            { value: 'mobile', label: 'Mobile Application' },
            { value: 'design', label: 'UI/UX Design' },
            { value: 'other', label: 'Other' },
        ];


        // --- Utility Functions ---

        /** Retrieves the CSRF token from cookies (essential for cross-origin POST) */
        function getCsrfToken() {
            const name = 'csrftoken';
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
            }
            return null;
        }

        /** Shows a temporary success or error message */
        function showMessage(text, type = 'success') {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.style.opacity = 1;
            box.classList.remove('bg-green-500', 'bg-red-500');
            box.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');

            setTimeout(() => {
                box.style.opacity = 0;
            }, 3000);
        }

        /** Generic fetch wrapper for API interaction (handles JSON) */
        async function fetchData(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
            };
            
            // Add CSRF token for non-GET requests if not FormData
            if (options.method && options.method !== 'GET' && !(options.body instanceof FormData)) {
                const csrfToken = getCsrfToken();
                if (csrfToken) {
                    options.headers['X-CSRFToken'] = csrfToken;
                }
            }

            // Remove Content-Type header if body is FormData (browser sets it correctly)
            if (options.body instanceof FormData) {
                delete defaultOptions.headers['Content-Type'];
            }

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (response.status === 401 || response.status === 403) {
                if (currentState.user && currentState.user.is_authenticated) {
                    currentState.user = null;
                    renderApp();
                    showMessage('Session expired or unauthorized. Please log in again.', 'error');
                }
            }

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                }
                return data;
            } else {
                 if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response;
            }
        }


        // --- API Calls ---

        async function checkAuth() {
            try {
                const user = await fetchData(`${API_BASE_URL}/user/`);
                currentState.user = user.is_authenticated ? user : null;
            } catch (error) {
                console.error('Auth check failed:', error);
                currentState.user = null;
            }
        }

        async function fetchProjects(username = null) {
            let url = `${API_BASE_URL}/projects/`;
            if (username) {
                url = `${API_BASE_URL}/portfolio/${username}/`;
            }

            try {
                currentState.projects = await fetchData(url);
            } catch (error) {
                console.error('Failed to load projects:', error);
                currentState.projects = [];
            }
        }

        async function fetchProjectDetail(projectId) {
            try {
                const project = await fetchData(`${API_BASE_URL}/projects/${projectId}/`);
                currentState.currentProjectDetail = project;
                renderProjectDetailModal();
            } catch (error) {
                showMessage(`Failed to load project details: ${error.message}`, 'error');
            }
        }

        async function handleAuthForm(event, endpoint) {
            event.preventDefault();
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            
            if (!data.username || !data.password) {
                showMessage('Username and password are required.', 'error');
                return;
            }
            
            try {
                const user = await fetchData(`${API_BASE_URL}/${endpoint}/`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                });
                
                currentState.user = user;
                showMessage(`Welcome, ${user.username}!`);
                currentState.view = 'dashboard';
                renderApp();

            } catch (error) {
                showMessage(`Authentication failed: ${error.message}`, 'error');
            }
        }

        async function handleLogout() {
            try {
                await fetchData(`${API_BASE_URL}/logout/`, {
                    method: 'POST',
                });
                currentState.user = null;
                showMessage('Successfully logged out.', 'success');
                currentState.view = 'auth';
                renderApp();
            } catch (error) {
                showMessage(`Logout failed: ${error.message}`, 'error');
            }
        }

        async function handlePostProject(event) {
            event.preventDefault();
            const form = event.target;
            
            // Use FormData for file upload
            const formData = new FormData(form);

            // Simple URL validation
            if (!formData.get('title') || !formData.get('project_url')) {
                showMessage('Title and Demo/Primary Link are required.', 'error');
                return;
            }

            try {
                const newProject = await fetchData(`${API_BASE_URL}/projects/`, {
                    method: 'POST',
                    // Note: No Content-Type header when using FormData
                    body: formData,
                });
                
                // Add the new project to the list and re-render
                currentState.projects.unshift(newProject);
                form.reset();
                showMessage('Project successfully posted!', 'success');
                renderApp();

            } catch (error) {
                showMessage(`Posting failed: ${error.message}`, 'error');
            }
        }

        async function handleLikeToggle(projectId) {
            if (!currentState.user) {
                showMessage('You must be logged in to like a project.', 'error');
                return;
            }

            try {
                const response = await fetchData(`${API_BASE_URL}/projects/${projectId}/like/`, {
                    method: 'POST',
                    body: JSON.stringify({}), // Empty body is fine for toggle
                });

                // Update the project's state immediately
                let projectToUpdate = currentState.projects.find(p => p.id === projectId);
                if (projectToUpdate) {
                    projectToUpdate.likes_count = response.likes_count;
                    // For the detail modal
                    if (currentState.currentProjectDetail && currentState.currentProjectDetail.id === projectId) {
                        currentState.currentProjectDetail.likes_count = response.likes_count;
                        currentState.currentProjectDetail.user_has_liked = response.action === 'liked';
                        renderProjectDetailModal(); // Re-render modal to show changes
                    }
                    renderApp(); // Re-render dashboard list to show changes
                }
                
                showMessage(`Project ${response.action}!`, 'success');

            } catch (error) {
                showMessage(`Like failed: ${error.message}`, 'error');
            }
        }

        async function handlePostComment(event, projectId) {
            event.preventDefault();
            if (!currentState.user) {
                showMessage('You must be logged in to comment.', 'error');
                return;
            }
            
            const form = event.target;
            const content = form.elements.comment_content.value.trim();

            if (!content) {
                showMessage('Comment cannot be empty.', 'error');
                return;
            }

            try {
                const newComment = await fetchData(`${API_BASE_URL}/projects/${projectId}/comments/`, {
                    method: 'POST',
                    body: JSON.stringify({ content }),
                });

                // Update state and re-render the modal
                if (currentState.currentProjectDetail && currentState.currentProjectDetail.id === projectId) {
                    currentState.currentProjectDetail.comments.push(newComment);
                    form.reset();
                    renderProjectDetailModal();
                }
                showMessage('Comment posted!', 'success');
            } catch (error) {
                showMessage(`Comment failed: ${error.message}`, 'error');
            }
        }


        // --- Rendering Logic ---

        function renderAuthView() {
            // ... (Auth forms remain largely the same, but default view is now login)
             return `
                <div class="max-w-md mx-auto mt-10 p-8 bg-white rounded-xl shadow-2xl">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Access Hub</h2>
                    
                    <div class="flex space-x-4 mb-6">
                        <button onclick="currentState.view='login'; renderApp()" 
                                class="flex-1 p-3 text-center rounded-lg font-medium transition duration-200 
                                ${currentState.view === 'login' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-indigo-50'}">
                            Login
                        </button>
                        <button onclick="currentState.view='register'; renderApp()" 
                                class="flex-1 p-3 text-center rounded-lg font-medium transition duration-200 
                                ${currentState.view === 'register' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700 hover:bg-indigo-50'}">
                            Register
                        </button>
                    </div>

                    ${currentState.view === 'login' ? renderLoginForm() : renderRegisterForm()}
                </div>
            `;
        }

        function renderLoginForm() {
            return `
                <form id="login-form" onsubmit="handleAuthForm(event, 'login')">
                    <div class="mb-5">
                        <label for="username_login" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username_login" name="username" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    <div class="mb-6">
                        <label for="password_login" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password_login" name="password" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    <button type="submit" 
                            class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                        Sign In
                    </button>
                </form>
            `;
        }
        
        function renderRegisterForm() {
             return `
                <form id="register-form" onsubmit="handleAuthForm(event, 'register')">
                    <div class="mb-4">
                        <label for="username_register" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username_register" name="username" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    <div class="mb-4">
                        <label for="email_register" class="block text-sm font-medium text-gray-700 mb-1">Email (Optional)</label>
                        <input type="email" id="email_register" name="email" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    <div class="mb-6">
                        <label for="password_register" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password_register" name="password" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    </div>
                    <button type="submit" 
                            class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                        Register Account
                    </button>
                </form>
            `;
        }

        function renderPostForm() {
            if (!currentState.user) return ''; // Only show if logged in

            const projectTypeOptionsHtml = PROJECT_TYPE_OPTIONS.map(opt => 
                `<option value="${opt.value}">${opt.label}</option>`
            ).join('');

            return `
                <div class="p-6 bg-white rounded-xl shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Post Your Project Demo</h3>
                    <form id="post-form" onsubmit="handlePostProject(event)" enctype="multipart/form-data">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="space-y-4">
                                <div>
                                    <label for="title" class="block text-sm font-medium text-gray-700">Project Title *</label>
                                    <input type="text" id="title" name="title" required
                                           class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="project_url" class="block text-sm font-medium text-gray-700">Demo/Primary Link *</label>
                                    <input type="url" id="project_url" name="project_url" required
                                           class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://">
                                </div>
                                <div>
                                    <label for="project_type" class="block text-sm font-medium text-gray-700">Category</label>
                                    <select id="project_type" name="project_type"
                                            class="mt-1 w-full p-3 border border-gray-300 bg-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                        ${projectTypeOptionsHtml}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                    <textarea id="description" name="description" rows="5"
                                              class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Briefly describe your project..."></textarea>
                                </div>
                                <div class="flex items-center pt-2">
                                    <input id="is_public" name="is_public" type="checkbox" checked
                                           class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="is_public" class="ml-2 block text-sm font-medium text-gray-700">
                                        Post Publicly (Uncheck for private portfolio)
                                    </label>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label for="screenshot" class="block text-sm font-medium text-gray-700">Screenshot (File Upload)</label>
                                    <input type="file" id="screenshot" name="screenshot" accept="image/*"
                                           class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                </div>
                                <div class="pt-2">
                                    <label for="screenshot_url_fallback" class="block text-sm font-medium text-gray-700">OR Image Link (Fallback)</label>
                                    <input type="url" id="screenshot_url_fallback" name="screenshot_url_fallback"
                                           class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://i.imgur.com/image.png">
                                </div>
                            </div>
                        </div>
                        <button type="submit" 
                                class="mt-6 w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-lg">
                            Submit Project Post
                        </button>
                    </form>
                </div>
            `;
        }

        function renderProjectCard(project) {
            const imageUrl = project.screenshot_url || 'https://via.placeholder.com/400x250?text=No+Screenshot';
            
            return `
                <div class="bg-white rounded-xl shadow-lg transition duration-300 hover:shadow-xl flex flex-col cursor-pointer" 
                     onclick="fetchProjectDetail(${project.id})">
                    
                    <div class="h-48 rounded-t-xl overflow-hidden">
                        <img src="${imageUrl}" alt="${project.title} screenshot" 
                             class="w-full h-full object-cover transition duration-300 hover:scale-105">
                    </div>

                    <div class="p-4 flex flex-col flex-grow">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xl font-bold text-gray-800 truncate">${project.title}</h4>
                            <span class="text-xs font-semibold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full whitespace-nowrap">${project.project_type}</span>
                        </div>
                        
                        <p class="text-gray-600 mb-3 text-sm flex-grow line-clamp-3">${project.description || 'No description provided.'}</p>
                        
                        <div class="flex justify-between items-center text-sm text-gray-500 pt-2 border-t mt-auto">
                            <p>By: <a href="#" onclick="event.stopPropagation(); currentState.view='portfolio'; currentState.portfolioUser='${project.username}'; renderApp()" class="font-medium text-indigo-700 hover:text-indigo-900">${project.username}</a></p>
                            <div class="flex items-center space-x-3">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                    ${project.likes_count}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProjectDetailModal() {
            const modal = document.getElementById('project-detail-modal');
            const contentContainer = document.getElementById('modal-content');
            const p = currentState.currentProjectDetail;
            
            if (!p) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                return;
            }

            const likeButtonColor = p.user_has_liked ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
            const likeButtonText = p.user_has_liked ? 'Unlike' : 'Like';

            const resourcesHtml = p.resources && p.resources.length > 0 ? 
                `<ul class="list-disc pl-5 space-y-2 mt-2">
                    ${p.resources.map(r => `<li><a href="${r.resource_url}" target="_blank" class="text-indigo-600 hover:underline">${r.name}</a></li>`).join('')}
                </ul>` : `<p class="text-gray-500">No extra resources provided.</p>`;

            const commentsHtml = p.comments && p.comments.length > 0 ? 
                p.comments.map(c => 
                    `<div class="border-b pb-2 mb-2 text-sm">
                        <p class="font-semibold text-gray-800">${c.username}:</p>
                        <p class="text-gray-600 ml-3">${c.content}</p>
                        <span class="text-xs text-gray-400 block mt-1">${new Date(c.created_at).toLocaleString()}</span>
                    </div>`
                ).join('') : `<p class="text-gray-500">No comments yet. Be the first!</p>`;

            contentContainer.innerHTML = `
                <div class="p-6">
                    <button class="absolute top-4 right-4 text-gray-600 hover:text-gray-900" 
                            onclick="closeProjectDetailModal()">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <h2 class="text-3xl font-extrabold text-gray-900 mb-2">${p.title}</h2>
                            <p class="text-sm font-medium text-indigo-600 mb-4">${p.project_type}</p>

                            <img src="${p.screenshot_url || 'https://via.placeholder.com/800x500?text=No+Screenshot'}" 
                                 alt="${p.title} screenshot" 
                                 class="w-full h-auto rounded-lg shadow-xl object-cover max-h-96 mb-6">
                            
                            <div class="flex items-center justify-between border-t border-b py-3 mb-6">
                                <div class="flex items-center space-x-4">
                                    <button onclick="handleLikeToggle(${p.id})" class="flex items-center p-2 rounded-lg text-sm font-semibold transition duration-200 ${likeButtonColor} ${p.user_has_liked ? 'text-white' : ''}">
                                        <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                        ${p.likes_count} ${likeButtonText}
                                    </button>

                                    <a href="${p.project_url}" target="_blank" class="bg-emerald-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-emerald-600 transition duration-200">
                                        View Live Demo
                                    </a>
                                </div>
                                <span class="text-sm text-gray-500">
                                    Posted by: <a href="#" onclick="event.stopPropagation(); closeProjectDetailModal(); currentState.view='portfolio'; currentState.portfolioUser='${p.username}'; renderApp()" class="font-medium text-indigo-700 hover:text-indigo-900">${p.username}</a>
                                </span>
                            </div>

                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Description</h3>
                            <p class="text-gray-600 mb-6 whitespace-pre-wrap">${p.description || 'No detailed description provided.'}</p>
                            
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Project Resources</h3>
                            ${resourcesHtml}
                        </div>
                        
                        <div class="lg:col-span-1 border-l lg:pl-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">Comments (${p.comments ? p.comments.length : 0})</h3>
                            
                            ${currentState.user ? `
                                <form onsubmit="handlePostComment(event, ${p.id})" class="mb-6">
                                    <textarea name="comment_content" rows="3" required placeholder="Add a comment..."
                                              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"></textarea>
                                    <button type="submit" class="mt-2 w-full bg-indigo-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-indigo-600 transition duration-200">
                                        Post Comment
                                    </button>
                                </form>` : `<p class="text-sm text-red-500 mb-6">Log in to post a comment.</p>`}

                            <div class="max-h-[50vh] overflow-y-auto space-y-4 pr-2">
                                ${commentsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function closeProjectDetailModal() {
            document.getElementById('project-detail-modal').classList.add('hidden');
            document.getElementById('project-detail-modal').classList.remove('flex');
            currentState.currentProjectDetail = null;
        }


        function renderDashboardView() {
            const isPortfolio = currentState.view === 'portfolio';
            const projectsHtml = currentState.projects.length > 0
                ? currentState.projects.map(renderProjectCard).join('')
                : `<p class="text-center text-gray-500 py-10">No projects found ${isPortfolio ? `for ${currentState.portfolioUser}.` : 'yet. Be the first!'}</p>`;

            return `
                <div class="pb-10">
                    ${!isPortfolio ? renderPostForm() : ''}
                    
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 ${!isPortfolio ? 'mt-10' : ''} border-b pb-3">
                        ${isPortfolio ? `${currentState.portfolioUser}'s Portfolio` : `Community Projects (${currentState.projects.length})`}
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${projectsHtml}
                    </div>
                </div>
            `;
        }
        
        function renderHeaderNav() {
            const navContainer = document.getElementById('nav-actions');
            if (!navContainer) return;
            
            let navHtml = '';

            if (currentState.user) {
                // Logged In
                navHtml = `
                    <div class="flex items-center space-x-3">
                        <button onclick="currentState.view='portfolio'; currentState.portfolioUser='${currentState.user.username}'; renderApp()"
                                class="text-sm font-semibold text-indigo-700 hover:text-indigo-900 px-3 py-2 rounded-lg transition duration-200 bg-indigo-50 hover:bg-indigo-100">
                            My Portfolio
                        </button>
                        <span class="text-sm font-semibold text-gray-700 hidden sm:inline">
                            Welcome, ${currentState.user.username}!
                        </span>
                        <button onclick="handleLogout()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition duration-200 shadow-md">
                            Logout
                        </button>
                    </div>
                `;
            } else {
                // Logged Out
                navHtml = `
                    <button onclick="currentState.view='login'; renderApp()"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition duration-200 shadow-md">
                        Login / Register
                    </button>
                `;
            }
            navContainer.innerHTML = navHtml;
        }

        async function renderApp() {
            const container = document.getElementById('app-container');
            
            renderHeaderNav(); // Update nav first

            container.innerHTML = `<div class="text-center py-20 text-gray-500">Loading...</div>`;

            if (currentState.view === 'auth' || !currentState.user) {
                // Only show auth view if not logged in OR explicitly set to auth view
                if (!currentState.user) currentState.view = 'login'; 
                container.innerHTML = renderAuthView();
            } else if (currentState.view === 'portfolio') {
                // Handle portfolio view
                await fetchProjects(currentState.portfolioUser);
                container.innerHTML = renderDashboardView();
            } else {
                // Default to dashboard view
                await fetchProjects();
                container.innerHTML = renderDashboardView();
            }
        }


        // --- Initialization ---

        async function init() {
            currentState.loading = true;
            await checkAuth(); // Check and fetch user state
            currentState.loading = false;
            
            // Determine initial view state
            if (!currentState.user) {
                 currentState.view = 'auth';
            } else {
                currentState.view = 'dashboard';
            }

            renderApp();
        }

        window.onload = init;
    </script>
</body>
</html>





